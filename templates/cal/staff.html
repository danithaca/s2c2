{% extends "base_page.html" %}
{% load staticfiles %}
{% load bootstrap %}
{% load s2c2_tags %}

{% block extra_header %}
  <link href='{% static 'fullcalendar/fullcalendar.css' %}' rel='stylesheet' />
  <link href='{% static 'fullcalendar/fullcalendar.print.css' %}' rel='stylesheet' media='print' />
  <script src='{% static 'fullcalendar/lib/moment.min.js' %}'></script>
  <script src='{% static 'fullcalendar/fullcalendar.js' %}'></script>
  <style type="text/css">
    .offer-remove:hover {
      cursor: pointer;
      color: red;
    }
  </style>
  <script>
    $(document).ready(function() {

      /*$.get('{% url "cal:staff_events" uid=user_profile.pk %}', function(data) {
        console.log(data);
      });*/

      $('#calendar').fullCalendar({
        header: {
          left: 'prev,next today,template',
          center: 'title',
          right: 'agendaDay,agendaWeek'
        },
        defaultDate: '{{ day.to_fullcalendar }}',
        defaultView: 'agendaWeek',
        fixedWeekCount: false,
        allDaySlot: false,
        minTime: '06:00',
        maxTime: '21:00',
        scrollTime: '08:00',

        /*views: {
          templateWeek: {
            type: 'agenda',
            duration: { weeks: 1 },
            //weekends: false,
            buttonText: 'template',
            //start: '1900-01-01',
            //end: '1900-01-07',
            titleFormat: '[Every] dddd'
          }
        },*/

        selectable: true,
        selectHelper: true,
        selectConstraint: {
          start: '06:00',
          end: '21:00'
        },
        select: function(start, end) {
          //console.log(start.format('YYYYMMDD'));
          //console.log(start.format('HHmm'));
          var form_day = start.format('YYYYMMDD');
          // handle template string.
          if (start.isBetween('1900-01-01', '1900-01-08')) {
            form_day = start.format('d');
            console.log(form_day);
          }
          var form_start = start.format('HHmm');
          var form_end = end.format('HHmm');
          $.post('{% url "slot:offer_add" uid=user_profile.pk %}', {day: form_day, start_time: form_start, end_time: form_end}, function(data) {
            //console.log(data);
            if (data.status === 302) {
              window.location.replace(data.content);
            }
          });
          //var eventData;
          //eventData = {
          //  start: start,
          //  end: end
          //};
          //$('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
          //$('#calendar').fullCalendar('unselect');
          //$('#calendar').fullCalendar('refetchEvents');
        },

        firstDay: 1,
        //editable: true,
        eventLimit: true, // allow "more" link when too many events
        events: '{% url "cal:staff_events" uid=user_profile.pk %}',
        eventRender: function(event, element) {
          // append "offer remove" ajax link.
          $('div.fc-content div.fc-title', element).append(' <span class="glyphicon glyphicon-remove offer-remove" data-offer="' + event.id + '"></span>');
        }
      });

      $('#calendar').on('click', '.offer-remove', function(e) {
        e.stopPropagation();
        e.preventDefault();
        var [staff_id, day, start, end] = $(this).data('offer').split('-');
        //console.log(staff_id, day, start, end);
        // note: staff_id is not available to django backend. we'll assume user_profile.pk === staff_id
        $.post('{% url "slot:offer_delete" uid=user_profile.pk %}', {day: day, start_time: start, end_time: end}, function(data) {
          //console.log(data);
          if (data.status === 302) {
            window.location.replace(data.content);
          }
        });
      });

      //console.log($('#calendar').data('fullCalendar').getDate());

    }); // end of document.ready().
  </script>
{% endblock %}

{% block title %}Staff Calendar | S2C2{% endblock %}
{% block page-header %}Calendar <small>{% icon user %} {{ user|name }}</small>{% endblock %}

{% block page-content %}
<div class="row">
<div class="col-sm-9">
  <div id='calendar'></div>
</div>
<div class="col-sm-3">
</div>
</div>
{% endblock %}