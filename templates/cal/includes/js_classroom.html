<script>
  $(document).ready(function() {

    var param_day = getParameterByName('day');
    var day = param_day ? moment(param_day, 'YYYYMMDD') : moment();

    var calendarDefaults = getCalendarDefaults();
    $('#calendar').fullCalendar($.extend(calendarDefaults, {
      // about events

      events: '{% url "cal:classroom_events" cid=classroom.pk %}',
      eventRender: function(event, element, view) {
        // call default
        calendarDefaults.defaultEventRender(event, element, view);
        // append "offer remove" ajax link.
        $('div.fc-content div.fc-title', element).append(' <span class="glyphicon glyphicon-remove need-remove" data-need="' + event.id + '"></span>');
      },

      // about seletables

      selectable: true,
      selectHelper: true,
      selectConstraint: {
        start: '06:00',
        end: '21:00'
      },
      select: function(start, end, jsEvent, view) {
        //console.log(start.format('YYYYMMDD'));
        //console.log(start.format('HHmm'));
        var form_day = start.format('YYYYMMDD');
        // handle template string.
        /*if (start.isBetween('1900-01-01', '1900-01-08')) {
         form_day = start.format('d');
         console.log(form_day);
         }*/
        var form_start = start.format('HHmm');
        var form_end = end.format('HHmm');

        if (jsEvent.shiftKey) {
          // delete empty slot
          $.post('{% url "cal:need_delete_ajax" cid=classroom.pk %}', {day: form_day, start_time: form_start, end_time: form_end, user_id: 0}, function(data) {
            //console.log(data);
            if (data.success) {
              //window.location.replace(data.content);
              fullcalendar_refresh($('#calendar'));
              display_ajax_messages();
            }
            else {
              display_message('Permission not allowed or other errors.', 'danger');
            }
          });
        }
        else {
          // add empty slot.
          $.post('{% url "slot:need_add" cid=classroom.pk %}', {day: form_day, start_time: form_start, end_time: form_end, howmany: 1}, function(data) {
            //console.log(data);
            if (data.status === 302) {
              //window.location.replace(data.content);
              fullcalendar_refresh($('#calendar'));
              display_ajax_messages();
            }
            else if (data.status === 403) {
              display_message('Permission not allowed.', 'danger');
            }
          });
        }
      },

      // about view

      viewRender: function(view, element) {
        // update form.
        var current_day = view.calendar.getDate();
        var $form = $('#panel-classroom-copy');
        $form.find('input[name=current_date]').val(current_day.format('YYYYMMDD'));
        $form.find('select option[value=curr]').text('Current week ('+ current_day.clone().day(1).format('MMM.D') + ' ~ ' + current_day.clone().day(7).format('D') +')');
        $form.find('select option[value=prev]').text('Previous week ('+ current_day.clone().day(-6).format('MMM.D') + ' ~ ' + current_day.clone().day(0).format('D') +')');
        $form.find('select option[value=next]').text('Next week ('+ current_day.clone().day(8).format('MMM.D') + ' ~ ' + current_day.clone().day(14).format('D') +')');

        var $roster = $('#roster');
        var user_api = $roster.data('roster');
        if (user_api) {
          var start = view.intervalStart.format('YYYYMMDD');
          var end = view.intervalEnd.format('YYYYMMDD');
          user_api.refresh($roster.data('cid'), start, end);
        }

        calendarChangeBookmark(view);
      }
    }));

    // this gets bound later, and thus will be executed later than "eventClick".
    $('#calendar').on('click', '.need-remove', function(e) {
      e.stopPropagation();
      e.preventDefault();
      var id_data = $(this).data('need').split('-');
      var classroom_id = id_data[0], day = id_data[1], start = id_data[2], end = id_data[3], user_id = id_data[4];
      //console.log(classroom_id, day, start, end, user_id);
      // note: classroom.id is not available to django backend. we'll assume classroom.pk (in django) === classroom_id (in js)
      $.post('{% url "cal:need_delete_ajax" cid=classroom.pk %}', {day: day, start_time: start, end_time: end, user_id: user_id}, function(data) {
        //console.log(data);
        if (data.success) {
          //window.location.replace(data.content);
          fullcalendar_refresh($('#calendar'));
          display_ajax_messages();
        }
        else {
          display_message('Permission not allowed or other errors.', 'danger');
        }
      });
    });

    //$('#calendar').on('click', 'th.fc-day-header.fc-widget-header', function(e) {
    //  console.log(e.target);
    //});

  }); // end of document.ready().
</script>