{% extends "base_page.html" %}
{% load staticfiles %}
{% load bootstrap %}
{% load s2c2_tags %}

{% block extra_header %}
  <link href='{% static 'fullcalendar/fullcalendar.css' %}' rel='stylesheet' />
  <link href='{% static 'fullcalendar/fullcalendar.print.css' %}' rel='stylesheet' media='print' />
  <script src='{% static 'fullcalendar/lib/moment.min.js' %}'></script>
  <script src='{% static 'fullcalendar/fullcalendar.js' %}'></script>
  <script>
    $(document).ready(function() {

      $('#calendar').fullCalendar({
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'agendaDay,agendaWeek,month'
        },
        defaultDate: '{{ day.to_fullcalendar }}',
        defaultView: 'agendaWeek',
        fixedWeekCount: false,
        allDaySlot: false,
        minTime: '06:00',
        maxTime: '21:00',
        scrollTime: '08:00',

        selectable: true,
        selectHelper: true,
        selectConstraint: {
          start: '06:00',
          end: '21:00'
        },
        select: function(start, end) {
          //console.log(start.format('YYYYMMDD'));
          //console.log(start.format('HHmm'));
          var form_day = start.format('YYYYMMDD');
          // handle template string.
          /*if (start.isBetween('1900-01-01', '1900-01-08')) {
            form_day = start.format('d');
            console.log(form_day);
          }*/
          var form_start = start.format('HHmm');
          var form_end = end.format('HHmm');
          $.post('{% url "slot:need_add" cid=classroom.pk %}', {day: form_day, start_time: form_start, end_time: form_end, howmany: 1}, function(data) {
            //console.log(data);
            if (data.status === 302) {
              //window.location.replace(data.content);
              fullcalendar_refresh($('#calendar'));
              display_ajax_messages();
            }
            else if (data.status === 403) {
              display_message('Permission not allowed.', 'danger');
            }
          });
        },

        firstDay: 1,
        //editable: true,
        eventLimit: true,
        events: '{% url "cal:classroom_events" cid=classroom.pk %}',
        eventRender: function(event, element) {
          // append "offer remove" ajax link.
          $('div.fc-content div.fc-title', element).append(' <span class="glyphicon glyphicon-remove need-remove" data-need="' + event.id + '"></span>');
        },
        eventClick: function(event, jsEvent, view) {
          if (event.empty && !($(jsEvent.target).hasClass('need-remove'))) {
            var form_day = event.start.format('YYYYMMDD');
            var form_start = event.start.format('HHmm');
            var form_end = event.end.format('HHmm');
            $.get('{% url "cal:assign" cid=classroom.pk %}' + '?day=' + form_day + '&start=' + form_start + '&end=' + form_end, function(jsonResult) {
              //console.log(data);
              $('#modal-form').data('content', jsonResult.form);
              $('#modal-form').data('day', form_day);
              $('#modal-form').modal('show');
              display_ajax_messages();
            });
          }
        },

        viewRender: function(view, element) {
          // update form.
          var current_day = view.calendar.getDate();
          var $form = $('#panel-classroom-copy');
          $form.find('input[name=current_date]').val(current_day.format('YYYYMMDD'));
          $form.find('select option[value=curr]').text('Current week ('+ current_day.clone().day(1).format('MMM.D') + ' ~ ' + current_day.clone().day(7).format('D') +')');
          $form.find('select option[value=prev]').text('Previous week ('+ current_day.clone().day(-6).format('MMM.D') + ' ~ ' + current_day.clone().day(0).format('D') +')');
          $form.find('select option[value=next]').text('Next week ('+ current_day.clone().day(8).format('MMM.D') + ' ~ ' + current_day.clone().day(14).format('D') +')');
          window.history.pushState(current_day, null, './?day=' + current_day.format('YYYYMMDD') + '&view=' + view.calendar.getView().type);
        }
      });

      // this gets bound later, and thus will be executed later than "eventClick".
      $('#calendar').on('click', '.need-remove', function(e) {
        e.stopPropagation();
        e.preventDefault();
        var [classroom_id, day, start, end, user_id] = $(this).data('need').split('-');
        //console.log(classroom_id, day, start, end, user_id);
        // note: classroom.id is not available to django backend. we'll assume classroom.pk (in django) === classroom_id (in js)
        $.post('{% url "cal:need_delete_ajax" cid=classroom.pk %}', {day: day, start_time: start, end_time: end, user_id: user_id}, function(data) {
          //console.log(data);
          if (data.success) {
            //window.location.replace(data.content);
            fullcalendar_refresh($('#calendar'));
            display_ajax_messages();
          }
          else {
            display_message('Permission not allowed or other errors.', 'danger');
          }
        });
      });

      $('#modal-form').on('show.bs.modal', function (event) {
        //console.log(event);
        var modal = $(this);
        //console.log(modal.data('content'));
        modal.find('#modal-form-content').html(modal.data('content'));

        //var button = $(event.relatedTarget);
        //var recipient = button.data('whatever');
        //var modal = $(this);
        //modal.find('.modal-title').text('New message to ' + recipient);
        //modal.find('.modal-body input').val(recipient);
      });

      $('#modal-form-submit').click(function() {
        var form_day = $('#modal-form').data('day');
        $.post('{% url "cal:assign" cid=classroom.pk %}' + '?day=' + form_day, $('#modal-form form').serialize(), function(data) {
          //console.log(data);
          if (data.success) {
            //window.location.replace(data.content);
            $('#modal-form').modal('hide');
            fullcalendar_refresh($('#calendar'));
            display_ajax_messages();
          }
        });
      });

    }); // end of document.ready().
  </script>
{% endblock %}

{% block title %}Classroom Calendar | S2C2{% endblock %}

{% block page-header %}{% icon classroom %} {{ classroom|name }}{% endblock %}

{% block page-content %}
  <div class="row">
    <div class="col-sm-3">
      <div class="panel-group" id="calendar-panel-list">
        {#{% include "cal/includes/panel_classroom_comment.html" with panel_id="panel-classroom-comment" panel_title="Notes" panel_collapse=True %}#}
        {% include "cal/includes/panel_classroom_copy.html" with panel_id="panel-classroom-copy" panel_title="Copy" panel_collapse=True %}
      </div>
    </div>
    <div class="col-sm-9">
      <div id='calendar'></div>
    </div>
  </div>

  <div class="modal fade" id="modal-form">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Assign Staff</h4>
        </div>
        <div class="modal-body">
          <form class="form-horizontal" method="post" action="{% url 'cal:assign' cid=classroom.pk %}?day={{ day.to }}">
            {% csrf_token %}
            <div id="modal-form-content"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="modal-form-submit" type="submit">Assign</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
