{% extends 'base.html' %}
{% load account_tags %}
{% load p2_tags %}
{% load bootstrap %}

{% block extra_header %}
{% include 'includes/js_grid.html' %}
<style>
#content-introduction  {
  min-height: 190px;
}
</style>
<script>
$(document).ready(function() {
  var $grid = $('#grid-list-connections');

  // change filter
  var $filter_option = $('select[name="select-connection-show"]');
  $filter_option.change(function() {
    var option = $filter_option.val();
    if (option == 'parent') {
      $grid.isotope({filter: '[data-option="parent"]'});
    }
    else if (option == 'sitter') {
      $grid.isotope({filter: '[data-option="sitter"]'});
    }
    else if (option == 'group') {
      $grid.isotope({filter: '[data-option="group"]'});
    }
    else if (option == 'all') {
      $grid.isotope({filter: '*'});
    }
  });

  // handle group filter
  $('#grid-quicksearch').keyup(function() {
    var qsRegex = new RegExp( $(this).val(), 'gi' );
    $grid.isotope({filter: function() {
      return qsRegex ? $(this).text().match( qsRegex ) : true;
      // return qsRegex ? $(this).find('.card').data('slug').match( qsRegex ) : true;
    }});
  });

  // handle remove
  $('.destroy-btn').click(function(e) {
    var $this = $(this);
    var url = $this.data('url');
    if (url) {
      bootbox.confirm('Are you sure you want to remove this person from your network? ', function(result) {
        if (result) {
          $.post(url, function(data) {
            if (data['success']) {
              window.location.reload();
            }
          });
        }
      });
    }
  });
});
</script>
{% endblock %}

{% block panel-attributes %}data-uid="{{ target_user.id }}"{% endblock %}

{% block content-command-list %}
  {% if current_user != target_user %}
    <div class="btn-group btn-group-sm">
    <a class="btn btn-primary" href="{% url 'shout:user' uid=target_user.id %}"><i class="fa fa-bullhorn"></i> Message</a>
    {% if user_membership.is_active and not user_membership.is_disapproved %}
      <a href="{% url 'circle:membership_edit' pk=user_membership.id %}" class="btn btn-warning" title="{{ user_membership.note|default:'No endorsement statement.' }}" data-toggle="tooltip"><i class="fa fa-edit"></i> Endorse</a>
      <span class="btn btn-default destroy-btn" data-url="{% url 'circle:membership_deactivate' pk=user_membership.id %}"><i class="fa fa-sign-out"></i> {% if target_user.is_sitter %}Remove{% else %}Unfriend{% endif %}</span>
    {% else %}
      {% if target_user.is_sitter %}
        <a href="{% url 'circle:sitter_add' uid=target_user.id %}" class="btn btn-success"><i class="fa fa-user-plus"></i> Add</a>
      {% else %}
        <a href="{% url 'circle:parent_add' uid=target_user.id %}" class="btn btn-success"><i class="fa fa-user-plus"></i> Add</a>
      {% endif %}
    {% endif %}
    </div>
  {% else %}
    <div class="btn-group btn-group-sm">
      <div class="btn-group btn-group-sm">
        <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><i class="fa fa-pencil"></i> Edit My Account <span class="caret"></span></button>
        <ul class="dropdown-menu">
          {% for menu_item in edit_account_menu_items %}
            <li><a href="{{ menu_item.1 }}">{{ menu_item.0 }}</a></li>
          {% endfor %}
        </ul>
      </div>
      <a class="btn btn-default" href="{% url 'account_logout' %}"><i class="fa fa-sign-out"></i> Log out</a>
    </div>
  {% endif %}
{% endblock %}

{% block content-introduction %}
  {% if current_user == target_user %}
    <a href="{% url 'account_picture' %}"><img src="{% user_picture_url target_user %}" align="right" alt="user picture" class="img-thumbnail img-round img-150"></a>
  {% else %}
    <img src="{% user_picture_url target_user %}" align="right" alt="user picture" class="img-thumbnail img-round img-150">
  {% endif %}
  <p class="section-title">
    {% user-full-name target_user %}
  </p>
  <p class="text-large">
    {% if not target_user.is_registered %}<span class="label label-danger">Unregistered</span>{% endif %}
    {% include 'elements/user_level.html' with user=target_user only %}
    {% if interactions %}{% include 'elements/interactions.html' with count=interactions help='Previous number of interactions with this user on babysitting.' %}{% endif %}
  </p>
  {% if reverse_user_connection.trusted %}
    <ul class="list-inline">
      <li><i class="fa fa-envelope"></i> {{ target_user.email }}</li>
      {% if target_user.info.phone %}
        <li><i class="fa fa-phone"></i> {{ target_user.info.phone }}</li>
      {% endif %}
      {% if target_user.info.address %}
        <li><i class="fa fa-map-marker"></i> {{ target_user.info.address }} <a href="https://www.google.com/maps/place/{{ target_user.info.address|urlencode }}" target="_blank"><i class="fa fa-external-link"></i></a></li>
      {% endif %}
    </ul>
  {% endif %}
  {% if target_user.info.note %}
    <p class="text-large">{{ target_user.info.note }}</p>
  {% endif %}
{% endblock %}

{% block content %}
{#  <div class="min-margin-bottom">#}
{#    {% for circle in current_user_shared_circles %}#}
{#      {% if circle.owner == current_user %}#}
{#        <span class="label label-success">{{ circle.display }}</span>#}
{#      {% else %}#}
{#        <span class="label label-primary">{{ circle.display }}</span>#}
{#      {% endif %}#}
{#    {% endfor %}#}
{#  </div>#}

  {% if list_personal_membership or list_public_membership %}
  <div class="section-title">Connections & Social Groups</div>

  <div class="horizontal-justified min-margin-bottom">
    {#  <div class="input-group">#}
    {#    <span class="input-group-addon">Filter</span>#}
    {#    <input id="grid-quicksearch" class="form-control" placeholder="Search ...">#}
    {#  </div>#}
    <div class="">
      <input id="grid-quicksearch" class="form-control" placeholder="Type to search ...">
    </div>
    <div class="form-group">
{#      <label class="control-label" for="select-connection-show">Show</label>#}
      <select class="form-control" name="select-connection-show">
        <option selected value="all">Show All</option>
        <option value="parent">Show Parents</option>
        <option value="sitter">Show Babysitters</option>
        <option value="group">Show Social Groups</option>
      </select>
    </div>
  </div>

  <div class="grid" id="grid-list-connections">
    {% for membership in list_personal_membership %}
      <div class="grid-item" data-option="{{ membership.js_display_role }}">{% include 'includes/card/membership.html' with membership=membership user=membership.member.to_puser only %}</div>
    {% endfor %}
    {% for membership in list_public_membership %}
      <div class="grid-item" data-option="group">{% include 'includes/card/group.html' with circle=membership.circle only %}</div>
    {% endfor %}
  </div>
  {% endif %}

{% endblock %}
