{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap %}
{% load p2_tags %}

{% block extra_header %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    // update status
    $('button[name="change-status"]').click(function() {
      var op = $(this).val();
      var post_data = {op: op};
      if (op == 'confirm') {
        post_data['match_id'] = $(this).data('match-id');
      }

      // for revert, do the confirmation box.
      if (op == 'revert' || op == 'cancel') {
        messages = {
          revert: 'This operation will undo the confirmed request. The babysitter will be notified. You can choose another babysitter.',
          cancel: 'This operation cannot be undone.'
        }
        bootbox.confirm({
          title: 'Are you sure?',
          message: messages[op],
          buttons: {
            cancel: {label: 'No'},
            confirm: {label: 'Yes'}
          },
          callback: function(result) {
            if (result) {
              $.post("{% url 'contract:change_status' pk=contract.id %}", post_data, function(data) {
                location.reload();
              });
            }
          }
        });
      }
      else {
        $.post("{% url 'contract:change_status' pk=contract.id %}", post_data, function(data) {
          location.reload();
        });
      }
    });
  });
</script>
{% endblock %}

{% block page %}
<div class="row" id="contract-basic-view" data-contract-id="{{ contract.id }}">
  <div class="col-xs-6 col-sm-3 col-md-2">
    {% include 'contract/includes/user_preview.html' with user=contract.initiate_user %}
  </div>
  <div class="col-xs-6 col-sm-3 col-md-2">
    {% if contract.confirmed_match %}
      {% include 'contract/includes/user_preview.html' with user=contract.confirmed_match.target_user %}
    {% else %}
      {% include 'contract/includes/match_not_found.html' %}
    {% endif %}
  </div>
  <div class="col-sm-6 col-md-8">
    <p class="text-xx-large">
      <span class="label label-default">Status - {% contract-status contract.status %}</span>
      {% if contract.is_confirmed %}
        <button class="btn btn-danger" name="change-status" value="revert">Undo</button>
        <button class="btn btn-default" name="change-status" value="cancel">Cancel</button>
      {% elif contract.is_active %}
        <button class="btn btn-warning" name="change-status" value="edit">Edit</button>
        <button class="btn btn-default" name="change-status" value="cancel">Cancel</button>
      {% endif %}
    </p>
    <table class="table table-striped table-hover">
      <tbody>
      <tr>
        <th scope="row">Time</th>
        <td>Start: {{ contract.event_start }}, End: {{ contract.event_end }}</td>
      </tr>
      <tr>
        <th scope="row">Compensation</th>
        <td>
          {% if contract.price > 0 %}
          ${{ contract.price }} <small>(${{ contract.hourly_rate }}/hour)</small>
          {% else %}
          No monetary compensation. This will be based on exchange of favors.
          {% endif %}
        </td>
      </tr>
      <tr>
        <th scope="row">Note</th>
        <td>{{ contract.description }}</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>
<hr>
<div class="row">
{% if matches %}
{% for match in matches %}
  <div class="col-xs-6 col-sm-3 col-md-2">
    {% include 'contract/includes/match_preview.html' with match=match contract=contract %}
  </div>
{% endfor %}
{% else %}
  <div class="col-sm-12">We will forward your request to your personal and public circles momentarily.</div>
{% endif %}
</div>
{% endblock %}
